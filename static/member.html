<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member</title>
    <link rel="stylesheet" href="/static/main.css">
</head>

<body>
    <!-- Navigation Bar -->
    <div class="nav-bar">
        <div class="nav-content">
            <a href="/" class="nav-title">å°åŒ—ä¸€æ—¥éŠ</a>
            <div class="nav-btn">
                <button class="btn-booking">é å®šè¡Œç¨‹</button>
                <button class="btn-sign">ç™»å…¥&nbsp;/&nbsp;è¨»å†Š</button>
            </div>
        </div>
    </div>
    <hr class="nav-divider">
    <!-- Member Section -->
    <div class="member-container">
        <section class="member-section">
            <h2 id="welcome-text">æ­¡è¿å›ä¾†ï¼</h2>
            <br>
            <div class="member-info">
                <h3 class="section-title">æœƒå“¡è³‡æ–™ï¼š</h3>
                <div class="avatar-display" style="margin-bottom: 10px;">
                    <img id="memberAvatar" src="" alt="æœƒå“¡å¤§é ­è²¼"
                        style="width: 120px; height: 120px; object-fit: cover; border-radius: 50%; border: 2px solid #ccc; display: none;" />
                </div>
                <p>å§“åï¼š<span id="member-name"></span>
                    <button id="edit-name-btn">âœï¸</button>
                </p>
                <div id="edit-name-group" style="display:none;">
                    <input type="text" id="edit-name-input" maxlength="20" />
                    <button id="save-name-btn">å„²å­˜</button>
                    <button id="cancel-name-btn">å–æ¶ˆ</button>
                </div>

                <p>Emailï¼š<span id="member-email"></span></p>
            </div>
            <!-- ä¸Šå‚³å¤§é ­è²¼å€å¡Š -->
            <div class="avatar-upload-section" style="margin-top: 20px;">
                <p class="section-title">å¤§é ­è²¼ï¼š
                    <input type="file" id="avatarInput" accept="image/*" style="display: none; width: auto;" />
                    <button id="chooseFileBtn">é¸æ“‡åœ–ç‰‡</button>
                    <button id="uploadAvatarBtn">ä¸Šå‚³</button>
                </p>
                <div id="avatarPreview" style="margin-top:10px;">
                    <img id="avatarImage" src="" alt="é è¦½å¤§é ­è²¼"
                        style="width:100px; height:100px; object-fit:cover; display:none; border-radius: 50%; border: 1px solid #ccc;" />
                </div>
            </div>
            <hr class="section-divider">
            <h3 class="section-title">æˆ‘çš„æ­·å²è¨‚å–®ï¼š</h3>
            <div id="order-history" class="order-list"></div>

            <div id="load-more-container" style="text-align:center; margin-top: 20px;">
                <button id="load-more-btn" style="display: none;">è¼‰å…¥æ›´å¤š</button>
            </div>
        </section>
    </div>


    <!-- Footer -->
    <footer>
        <div>COPYRIGHT Â© 2025 å°åŒ—ä¸€æ—¥éŠ</div>
    </footer>


    <!--  ç™»å…¥ / è¨»å†Šè¦–çª—çµæ§‹ -->
    <div class="auth-overlay" style="display:none">
        <div class="auth-modal">
            <!-- decorator bar è£é£¾æ¢ -->
            <div class="auth-decorator"></div>

            <!-- ä¸»å…§å®¹å€å¡Š -->
            <div class="auth-main">
                <!-- é—œé–‰æŒ‰éˆ•æ”¾åœ¨ auth-main å³ä¸Šè§’ -->
                <img src="/static/icon_close.png" class="auth-close" alt="é—œé–‰">

                <!-- æ¨™é¡Œ -->
                <div class="auth-header">
                    <span id="form-switch">ç™»å…¥æœƒå“¡å¸³è™Ÿ</span>
                </div>

                <!-- è¡¨å–®å€å¡Š -->
                <form id="auth-form">
                    <div class="auth-group">
                        <input type="text" id="name" placeholder="è¼¸å…¥å§“å" style="display: none">
                        <input type="text" id="username" placeholder="è¼¸å…¥é›»å­ä¿¡ç®±">
                        <input type="password" id="password" placeholder="è¼¸å…¥å¯†ç¢¼">
                    </div>
                    <div class="auth-message" id="auth-message"></div>
                    <button type="submit" id="auth-submit">ç™»å…¥å¸³æˆ¶</button>
                    <div class="auth-footer">
                        <span id="switch-to-register">é‚„æ²’æœ‰å¸³æˆ¶ï¼Ÿé»æ­¤è¨»å†Š</span>
                        <span id="switch-to-login" style="display:none">å·²ç¶“æœ‰å¸³æˆ¶äº†ï¼Ÿé»æ­¤ç™»å…¥</span>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- ä¿®æ”¹å§“åæœªå¡«æç¤ºè¦–çª— -->
    <div class="date-alert-overlay" id="nameAlert" style="display:none;">
        <div class="date-alert-box">
            <p>è«‹è¼¸å…¥è‡³å°‘å…©å€‹å­—</p>
            <button id="closeNameAlert">çŸ¥é“äº†</button>
        </div>
    </div>
    <!-- ä¸Šå‚³å¤§é ­è²¼æç¤ºè¦–çª— -->
    <div class="date-alert-overlay" id="avatarAlert" style="display:none;">
        <div class="date-alert-box">
            <p id="avatarAlertText">è«‹é¸æ“‡ä¸€å¼µåœ–ç‰‡ï¼</p>
            <button id="closeAvatarAlert">ï¼¯ï¼«</button>
        </div>
    </div>
    <script>

        // é¸å–å½ˆçª—æ•´é«”å®¹å™¨
        const overlay = document.querySelector(".auth-overlay");
        // é¸å–ç™»å…¥/è¨»å†Šçš„è¡¨å–®å…ƒç´ 
        const form = document.getElementById("auth-form");
        // é¸å–ä½¿ç”¨è€…è¼¸å…¥çš„ å§“åæ¬„ä½ï¼ˆè¨»å†Šç”¨ï¼Œé è¨­éš±è—ï¼‰
        const nameInput = document.getElementById("name");
        // é¸å–ä½¿ç”¨è€…è¼¸å…¥çš„ å¸³è™Ÿï¼ˆemailï¼‰æ¬„ä½
        const usernameInput = document.getElementById("username");
        // é¸å–ä½¿ç”¨è€…è¼¸å…¥çš„ å¯†ç¢¼ æ¬„ä½
        const passwordInput = document.getElementById("password");
        // é¸å–é¡¯ç¤ºéŒ¯èª¤æˆ–æç¤ºè¨Šæ¯çš„å…ƒç´ ï¼ˆç´…è‰²éŒ¯èª¤æç¤º or ç¶ è‰²æ­£ç¢ºæç¤ºï¼‰
        const messageBox = document.getElementById("auth-message");
        // é¸å–é€å‡ºæŒ‰éˆ•ï¼ˆæ ¹æ“šç™»å…¥æˆ–è¨»å†Šæ¨¡å¼æ”¹è®Šæ–‡å­—ï¼‰
        const submitBtn = document.getElementById("auth-submit");
        // è¨˜éŒ„ç›®å‰æ˜¯å¦ç‚ºç™»å…¥æ¨¡å¼ï¼ˆtrue = ç™»å…¥, false = è¨»å†Šï¼‰
        let isLogin = true;


        // ç™»å…¥/è¨»å†ŠæŒ‰éˆ•ï¼ˆæ‰“é–‹å½ˆè·³è¦–çª—ï¼‰
        const signBtn = document.querySelector(".btn-sign");

        // é—œé–‰æŒ‰éˆ•ï¼ˆé—œé–‰å½ˆçª—ä¸¦æ¸…ç©ºè¡¨å–®ï¼‰
        const closeBtn = document.querySelector(".auth-close");
        closeBtn.addEventListener("click", () => {
            overlay.style.display = "none";      // éš±è—æ•´å€‹å½ˆçª—
            form.reset();                        // æ¸…ç©ºæ‰€æœ‰è¼¸å…¥æ¬„ä½
            messageBox.textContent = "";         // æ¸…ç©ºè¨Šæ¯é¡¯ç¤ºå€
        });

        // åˆ‡æ›è¨»å†Šæ¨¡å¼
        const switchToRegister = document.getElementById("switch-to-register");
        const switchToLogin = document.getElementById("switch-to-login");

        switchToRegister.addEventListener("click", () => {
            isLogin = false;                              // è¨­å®šç‚ºè¨»å†Šæ¨¡å¼
            nameInput.style.display = "block";            // é¡¯ç¤ºå§“åæ¬„ä½
            submitBtn.textContent = "è¨»å†Šæ–°å¸³æˆ¶";           // æ”¹è®Šé€å‡ºæŒ‰éˆ•æ–‡å­—
            switchToRegister.style.display = "none";      // éš±è— åˆ‡åˆ°è¨»å†Š æç¤º
            switchToLogin.style.display = "block";        // é¡¯ç¤º åˆ‡åˆ°ç™»å…¥ æç¤º
        });

        // åˆ‡æ›ç™»å…¥æ¨¡å¼
        switchToLogin.addEventListener("click", () => {
            isLogin = true;                               // è¨­å®šç‚ºç™»å…¥æ¨¡å¼
            nameInput.style.display = "none";             // éš±è—å§“åæ¬„ä½
            submitBtn.textContent = "ç™»å…¥";                // æ”¹è®Šé€å‡ºæŒ‰éˆ•æ–‡å­—
            switchToRegister.style.display = "block";     // é¡¯ç¤º åˆ‡åˆ°è¨»å†Š æç¤º
            switchToLogin.style.display = "none";         // éš±è— åˆ‡åˆ°ç™»å…¥ æç¤º 
        });

        // è¡¨å–®é€å‡ºï¼šç™»å…¥æˆ–è¨»å†Š API å‘¼å«
        form.addEventListener("submit", async (e) => {
            e.preventDefault(); // é˜²æ­¢è¡¨å–®é è¨­è·³é 
            // å–å¾—ä½¿ç”¨è€…è¼¸å…¥å€¼
            const name = nameInput.value;
            const username = usernameInput.value;
            const password = passwordInput.value;
            // æª¢æŸ¥ email æ ¼å¼æ˜¯å¦æ­£ç¢º
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!emailRegex.test(username)) {
                messageBox.textContent = "è«‹è¼¸å…¥æ­£ç¢ºçš„é›»å­ä¿¡ç®±æ ¼å¼";
                messageBox.style.color = "red";
                return;
            }
            // æ ¹æ“šç›®å‰ç‹€æ…‹æ±ºå®šè¦å‘¼å«å“ªå€‹ API èˆ‡çµ„æˆè«‹æ±‚ body
            const url = isLogin ? "/api/user/auth" : "/api/user";
            const body = isLogin
                ? { username, password }          // ç™»å…¥å‚³å¸³å¯†
                : { name, username, password };   // è¨»å†Šå¤šåŠ  name

            //å‘¼å« å¾Œç«¯ API  fetch ç™¼é€ POST è«‹æ±‚
            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                const data = await res.json();

                // API å‘¼å«æˆåŠŸï¼ˆres.ok ç‚º trueï¼‰
                // ç™»å…¥æˆåŠŸ 
                if (res.ok) {
                    if (isLogin) {
                        localStorage.setItem("token", data.token);   // å„²å­˜ JWT 
                        location.reload();                           // åˆ·æ–°é é¢ï¼ˆè®“ navbar æ›¿æ›æˆç™»å‡ºï¼‰
                    }
                    // è¨»å†ŠæˆåŠŸ  é¡¯ç¤ºç¶ è‰²è¨Šæ¯æç¤º
                    else {
                        messageBox.textContent = "è¨»å†ŠæˆåŠŸï¼Œè«‹é‡æ–°ç™»å…¥";
                        messageBox.style.color = "green";
                    }
                } else {
                    messageBox.textContent = data.message || "è«‹è¼¸å…¥æ­£ç¢ºçš„é›»å­ä¿¡ç®±æ ¼å¼";
                }
            } catch (err) {
                messageBox.textContent = "ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
            }
        });

        function showLoginModal() {
            overlay.style.display = "flex";
        }
        // æœƒå“¡ç™»å…¥ç‹€æ…‹æª¢æŸ¥
        async function checkLoginStatus() {
            const token = localStorage.getItem("token");
            const signBtn = document.querySelector(".btn-sign");
            try {
                const res = await fetch("/api/user/auth", {
                    method: "GET",
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                });

                const result = await res.json();

                if (result.data) {
                    // å¦‚æœ token å­˜åœ¨ï¼Œä»£è¡¨å·²ç™»å…¥
                    signBtn.textContent = "ç™»å‡º";
                    signBtn.onclick = () => handleLogout();
                } else {
                    //  token ç„¡æ•ˆ  é¡¯ç¤ºã€Œç™»å…¥ï¼è¨»å†Šã€
                    signBtn.textContent = "ç™»å…¥ï¼è¨»å†Š";
                    signBtn.onclick = () => showLoginModal();
                }
            } catch (error) {
                console.error("ç™»å…¥ç‹€æ…‹ç¢ºèªå¤±æ•—ï¼š", error);
            }
        }

        /* ç™»å‡ºæµç¨‹ */
        /* æ¸…é™¤ localStorage è£¡çš„ token */
        function handleLogout() {
            localStorage.removeItem("token");
            location.reload();
        }

        document.addEventListener("DOMContentLoaded", async () => {
            await checkLoginStatus();
            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = "/";
                return;
            }

            try {
                const res = await fetch("/api/user/auth", {
                    method: "GET",
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                });

                const result = await res.json();
                if (!result.data) {
                    window.location.href = "/";
                    return;
                }

                // è‡ªè¨‚ä¸Šå‚³æŒ‰éˆ•è§¸ç™¼ input file
                document.getElementById("chooseFileBtn").addEventListener("click", () => {
                    document.getElementById("avatarInput").click();
                });

                // é©—è­‰æˆåŠŸï¼Œé¡¯ç¤ºæœƒå“¡è³‡æ–™
                document.getElementById("member-name").textContent = result.data.name;
                document.getElementById("member-email").textContent = result.data.username;
                document.getElementById("welcome-text").textContent = `ğŸ‘‹  æ­¡è¿å›ä¾†ï¼Œ${result.data.name}ï¼`;

                // é¡¯ç¤ºå¤§é ­è²¼ï¼ˆå¦‚æœæœ‰ï¼‰
                if (result.data.avatar_url) {
                    const memberAvatar = document.getElementById("memberAvatar");
                    memberAvatar.src = result.data.avatar_url;
                    memberAvatar.style.display = "block";
                }
                // æ›¿æ› navbar ç‚ºã€Œé å®šè¡Œç¨‹ + ç™»å‡ºã€
                const navBtn = document.querySelector(".nav-btn");
                navBtn.innerHTML = `
                     <button id="to-booking" class="btn-booking">é å®šè¡Œç¨‹</button>
                     <button id="logout" class="btn-sign">ç™»å‡º</button>
                        `;
                document.getElementById("to-booking").addEventListener("click", () => {
                    window.location.href = "/booking";
                });
                document.getElementById("logout").addEventListener("click", () => {
                    localStorage.removeItem("token");
                    window.location.href = "/";
                });

                // è¼‰å…¥æ­·å²è¨‚å–® API 
                orderPage = 0;
                await loadOrderHistory(token);

            } catch (error) {
                console.error("ç™»å…¥ç‹€æ…‹æª¢æŸ¥å¤±æ•—:", error);
                window.location.href = "/";
            }
        });
        // ä¸Šå‚³å¤§é ­è²¼å‡½å¼
        const avatarInput = document.getElementById("avatarInput");
        const avatarImage = document.getElementById("avatarImage");

        avatarInput.addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    avatarImage.src = e.target.result;
                    avatarImage.style.display = "block";
                };
                reader.readAsDataURL(file);
            }
        });
        // ä¸Šå‚³å¤§é ­è²¼ å¾Œç«¯API /api/member/avatar

        document.getElementById("uploadAvatarBtn").addEventListener("click", async () => {
            const file = avatarInput.files[0];
            if (!file) {
                showAvatarAlert("è«‹é¸æ“‡ä¸€å¼µåœ–ç‰‡ï¼");
                return;
            }

            const formData = new FormData();
            formData.append("avatar", file);

            const token = localStorage.getItem("token");

            try {
                const res = await fetch("/api/member/avatar", {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${token}`
                    },
                    body: formData
                });

                const result = await res.json();
                if (res.ok && result.ok) {
                    showAvatarAlert("ä¸Šå‚³æˆåŠŸï¼");
                    avatarImage.src = result.avatar_url;
                    avatarImage.style.display = "block";
                } else {
                    showAvatarAlert("ä¸Šå‚³å¤±æ•—ï¼š" + (result.message || "è«‹ç¨å¾Œå†è©¦"));
                }
            } catch (err) {
                showAvatarAlert("ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                console.error("ä¸Šå‚³å¤±æ•—ï¼š", err);
            }
        });


        // æ­·å²è¨‚å–®è®€å–å‡½å¼  å¾Œç«¯API /api/orders/history
        let orderPage = 0;
        const orderPageSize = 5; // å¯èª¿æ•´æ¯é ç­†æ•¸
        let nextOrderPage = null;

        async function loadOrderHistory(token) {
            const historyBox = document.getElementById("order-history");
            // æ–°å¢æŒ‰éˆ•é¸å–
            const loadMoreBtn = document.getElementById("load-more-btn");

            try {
                const res = await fetch(`/api/orders/history?page=${orderPage}&size=${orderPageSize}`, {
                    method: "GET",
                    headers: { Authorization: `Bearer ${token}` },
                });

                const result = await res.json();

                if (!result.data || result.data.length === 0) {
                    if (orderPage === 0) { // åœ¨ç¬¬ä¸€æ¬¡è¼‰å…¥æ²’è³‡æ–™æ™‚é¡¯ç¤º
                        historyBox.innerHTML = `
                    <div class="empty-orders">
                        <p class="empty-message">ç›®å‰å°šç„¡æ­·å²è¨‚å–®</p>
                        <button class="explore-btn" onclick="location.href='/'">ğŸ‘‰é¦¬ä¸Šçœ‹æ™¯é»</button>
                    </div>
                `;
                    }
                    loadMoreBtn.style.display = "none"; // æ²’æœ‰æ›´å¤šè³‡æ–™å°±éš±è—æŒ‰éˆ•
                    return;
                }

                result.data.forEach(order => {
                    const isPaid = order.status === "PAID";
                    const statusText = isPaid ? "âœ… å·²ä»˜æ¬¾" : "âŒ› æœªä»˜æ¬¾";
                    const statusColor = isPaid ? "green" : "red";

                    const div = document.createElement("div");
                    div.classList.add("order-item");
                    div.innerHTML = `
                        <div class="order-card">
                        <img src="${order.attractionImage}" class="order-img" alt="æ™¯é»åœ–ç‰‡" />
                        <div class="order-info">
                            <p><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>${order.number}</p>
                            <p><strong>æ™¯é»åç¨±ï¼š</strong>${order.attractionName}</p>
                            <p><strong>æ—¥æœŸï¼š</strong>${order.date}</p>
                            <p><strong>æ™‚é–“ï¼š</strong>${order.time === 'morning' ? 'æ—©ä¸Š' : 'ä¸‹åˆ'}</p>
                            <p><strong>ç‹€æ…‹ï¼š</strong><span style="color:${statusColor}; font-weight:bold">${statusText}</span></p>
                        </div>
                        </div>
                        
                    `;
                    historyBox.appendChild(div);
                });

                nextOrderPage = result.nextPage;
                if (nextOrderPage !== null) {
                    loadMoreBtn.style.display = "inline-block";
                } else {
                    loadMoreBtn.style.display = "none";
                }
            } catch (err) {
                historyBox.textContent = "è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            }
        }
        // è¼‰å…¥æ›´å¤šæŒ‰éˆ•
        document.getElementById("load-more-btn").addEventListener("click", () => {
            if (nextOrderPage !== null) {
                orderPage = nextOrderPage;
                const token = localStorage.getItem("token");
                loadOrderHistory(token);
            }
        });

        // UpdateName API
        // é€²å…¥ç·¨è¼¯æ¨¡å¼
        document.getElementById("edit-name-btn").addEventListener("click", () => {
            const nameText = document.getElementById("member-name").textContent;
            document.getElementById("edit-name-input").value = nameText;
            document.getElementById("edit-name-group").style.display = "block";
        });

        // å–æ¶ˆç·¨è¼¯
        document.getElementById("cancel-name-btn").addEventListener("click", () => {
            document.getElementById("edit-name-group").style.display = "none";
        });

        // å„²å­˜ç·¨è¼¯ â†’ å‘¼å« API
        document.getElementById("save-name-btn").addEventListener("click", async () => {
            const newName = document.getElementById("edit-name-input").value.trim();
            const token = localStorage.getItem("token");

            if (!newName || newName.length < 2) {
                document.getElementById("nameAlert").style.display = "flex";
                return;
            }

            try {
                const res = await fetch("/api/user/name", {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`,
                    },
                    body: JSON.stringify({ name: newName }),
                });

                const result = await res.json();
                if (res.ok && result.ok) {
                    // æ›´æ–°ç•«é¢
                    document.getElementById("member-name").textContent = newName;
                    document.getElementById("welcome-text").textContent = `ğŸ‘‹ æ­¡è¿å›ä¾†ï¼Œ${newName}ï¼`;
                    document.getElementById("edit-name-group").style.display = "none";

                    //  æ¸…ç©º token å†è¨­ç½®æ–°çš„
                    localStorage.removeItem("token");

                    localStorage.setItem("token", result.token);


                    // ç­‰ token å¯«å…¥å¾Œå†åšç‹€æ…‹æª¢æŸ¥
                    await checkLoginStatus();

                } else {
                    alert(result.message || "ä¿®æ”¹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                }
            } catch (err) {
                console.error("ä¿®æ”¹éŒ¯èª¤ï¼š", err);
                alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        });

        // é—œé–‰æé†’è¦–çª—æŒ‰éˆ•
        document.getElementById("closeNameAlert").addEventListener("click", () => {
            document.getElementById("nameAlert").style.display = "none";
        });

        // é¡¯ç¤ºæµ®å‹•æç¤º
        function showAvatarAlert(message) {
            const alertBox = document.getElementById("avatarAlert");
            const alertText = document.getElementById("avatarAlertText");
            alertText.textContent = message;
            alertBox.style.display = "flex";
        }

        // é—œé–‰æç¤ºæŒ‰éˆ•
        document.getElementById("closeAvatarAlert").addEventListener("click", () => {
            document.getElementById("avatarAlert").style.display = "none";
        });
    </script>
</body>

</html>